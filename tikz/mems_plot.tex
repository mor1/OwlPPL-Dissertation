% !TeX root = ../a.tex

\newcommand{\perfgraphm}[1]{
  \pgfplotstableread[col sep = comma]{#1}\datatable
  \pgfplotstablegetcolsof{\datatable}
  \pgfmathtruncatemacro\numberofcols{(\pgfplotsretval-1)*0.5}

  \pgfplotsinvokeforeach{1,...,\numberofcols}{
    \pgfmathtruncatemacro\e{##1 + \numberofcols}
    \pgfplotstablegetcolumnnamebyindex{##1}\of{\datatable}\to{\colname}
    \addplot+[
    error bars/.cd,
    y dir=both,
    y explicit,
    error bar style={color=black}
    ]
    table
    [
    x expr=\coordindex,
    y index=##1,
    col sep=comma,
    y error index=\e
    ] {#1};
    \addlegendentryexpanded{\colname}
  }
}

\begin{tikzpicture}
  \pgfplotstableread[col sep = comma]{data/perf/memory/mems_coin.csv}\t
  \begin{groupplot}[
    group style={
      group name=my plots,
      group size=4 by 1,
      xlabels at=edge bottom,
      ylabels at=edge left,
      vertical sep=0cm,
      horizontal sep=0.3cm,
      yticklabels at=edge left,
    },
    typeset ticklabels with strut,
    enlarge x limits={abs=0.35},
    ylabel={memory (kB)},
    ymin=0,
    ymax=460000,
    ybar,
    xtick=data,
    xticklabels from table={\t}{model},
    height=3.5cm,
    width=0.3\textwidth,
    title={Title}
    ]

    \nextgroupplot[title=Sprinkler, legend to name=leg]
    \coordinate (c1) at (rel axis cs:0,1);
    \perfgraphm{data/perf/memory/mems_sprinkler.csv}

    \nextgroupplot[title=Biased Coin, legend to name=leg]
    \perfgraphm{data/perf/memory/mems_coin.csv}

    \nextgroupplot[title=Hidden Markov Model, legend to name=leg]
    \perfgraphm{data/perf/memory/mems_hmm.csv}

    \nextgroupplot[
    title=Linear Regression,
    legend style={
      legend columns=3,
      fill=none,
      draw=none,
    },
    legend to name=leg
    ]
    \coordinate (c2) at (rel axis cs:1,1);
    \perfgraphm{data/perf/memory/mems_linreg.csv}
  \end{groupplot}
  \coordinate (c3) at ($(c1)!.5!(c2)$);
  \node[above] at (c3 |- current bounding box.north)
  {\pgfplotslegendfromname{leg}};
\end{tikzpicture}
